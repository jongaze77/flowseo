# Story 1.1: User and Tenant Registration

## Status
Done

## Story
**As a** new user,
**I want** to be able to register an account and create a tenant for my team,
**so that** I can begin using the application with my team.

## Acceptance Criteria
1. User can register with username and password
2. During registration, user creates a tenant with a name
3. User is automatically associated with the created tenant
4. Registration validates unique usernames
5. Password requirements are enforced
6. Both user and tenant data are persisted to database

## Tasks / Subtasks
- [x] Task 0: Environment configuration setup (Pre-implementation)
  - [x] Configure Next.js dev server to use port 3060 (update package.json scripts)
  - [x] Check available PostgreSQL ports and configure database connection
  - [x] Set up PostgreSQL database named `flowseo_dev`
  - [x] Configure .env.local with database URL and port settings
- [x] Task 1: Set up database schema for users and tenants (AC: 1, 2, 3, 6)
  - [x] Create Prisma schema for User and Tenant models
  - [x] Configure database relationships between User and Tenant
  - [x] Run database migrations
- [x] Task 2: Create registration API endpoint (AC: 1, 2, 4, 5, 6)
  - [x] Implement POST /api/v1/tenants endpoint for tenant creation
  - [x] Implement user registration logic with tenant association
  - [x] Add username uniqueness validation
  - [x] Add password validation and hashing
  - [x] Add proper error handling and responses
- [x] Task 3: Create registration UI components (AC: 1, 2, 5)
  - [x] Create registration form component with username/password fields
  - [x] Add tenant name field to registration form
  - [x] Implement form validation on frontend
  - [x] Add proper error display and user feedback
- [x] Task 4: Testing (All ACs)
  - [x] Write unit tests for registration API endpoint
  - [x] Write E2E tests for registration flow using Playwright
  - [x] Test validation edge cases

## Dev Notes

**Project Setup Context:**
This is a new Next.js project with TypeScript, Tailwind CSS, Prisma, Zod, and Playwright already configured via the setup commands provided.

**Environment Configuration Requirements:**
- **Dev Server Port**: Must use port 3060 (not default 3000) to avoid conflicts with other projects
- **Database Name**: Use `flowseo_dev` for PostgreSQL database
- **Port Discovery**: Development agent must check available PostgreSQL ports (default 5432 may be in use)
- **Environment Files**: Configure .env.local with proper DATABASE_URL and NEXTAUTH_URL settings

**Data Models:**
- **User**: Contains username, password_hash, and tenant_id reference [Source: architecture/data-models.md#user]
- **Tenant**: Contains name and ai_api_keys JSONB field [Source: architecture/data-models.md#tenant]

**Database Schema:**
```sql
CREATE TABLE tenants (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    ai_api_keys JSONB
);

CREATE TABLE users (
    id UUID PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    tenant_id UUID REFERENCES tenants(id)
);
```
[Source: architecture/database-schema.md]

**API Specifications:**
- POST /api/v1/tenants endpoint for tenant creation [Source: architecture/rest-api-spec.md#/tenants]
- Request body should contain name field [Source: architecture/rest-api-spec.md#/tenants]
- Returns 201 on successful creation [Source: architecture/rest-api-spec.md#/tenants]

**Tech Stack Requirements:**
- Use TypeScript for all development [Source: architecture/tech-stack.md]
- Use Zod for data validation on frontend and backend [Source: architecture/tech-stack.md]
- Use Prisma for database ORM [Source: architecture/tech-stack.md]
- Use Tailwind CSS for styling [Source: architecture/tech-stack.md]
- Use Playwright for E2E testing [Source: architecture/tech-stack.md]

**File Locations:**
Current project structure is standard Next.js (differs from docs architecture which shows monorepo):
- API routes: `/src/app/api/` directory
- Components: `/src/components/` directory
- Database schema: `/prisma/schema.prisma`
- E2E tests: `/tests/` or `/e2e/` directory

**Project Structure Notes:**
The current project uses standard Next.js structure, not the monorepo structure shown in architecture docs. File locations should follow Next.js conventions.

### Testing
**Testing Standards from Architecture:**
- Use Playwright for end-to-end testing [Source: architecture/tech-stack.md]
- All tests must pass for story completion [Source: architecture/coding-standards.md]
- No specific testing strategy file found in architecture docs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-19 | 1.1 | Added environment configuration requirements (port 3060, flowseo_dev database) | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Database connection issues resolved by setting up proper PostgreSQL user permissions
- Prisma import path corrections for API routes
- Jest mocking configuration for proper unit test isolation
- Environment file configuration (.env.local overrides .env for local development)

### Completion Notes List
- ✅ All acceptance criteria implemented and tested
- ✅ Database schema created with proper relationships
- ✅ API endpoint follows REST conventions with comprehensive validation
- ✅ Frontend form implements real-time validation and error handling
- ✅ Unit tests cover all major code paths including error scenarios
- ✅ E2E tests validate complete user journey
- ✅ Password hashing implemented with bcryptjs (cost factor 12)
- ✅ Database transactions ensure data consistency

### File List
- `/package.json` - Added dev server port configuration, test scripts, and dependencies
- `/.env` - Updated with local database connection string
- `/prisma/schema.prisma` - Created User and Tenant models with relationships
- `/src/app/api/v1/tenants/route.ts` - Registration API endpoint implementation
- `/src/components/RegistrationForm.tsx` - React registration form component
- `/src/app/register/page.tsx` - Registration page layout
- `/src/app/page.tsx` - Updated landing page with registration link
- `/jest.config.js` - Jest configuration for unit testing
- `/jest.setup.js` - Jest setup file
- `/src/app/api/v1/tenants/__tests__/route.test.ts` - Comprehensive unit tests
- `/playwright.config.ts` - Playwright E2E testing configuration
- `/tests/registration.spec.ts` - End-to-end registration flow tests
- `/.eslintignore` - ESLint ignore configuration for generated files

## QA Results
*Results from QA Agent review will be populated here*