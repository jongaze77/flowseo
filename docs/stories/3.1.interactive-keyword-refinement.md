# Story 3.1: Interactive Keyword Refinement

## Status
Draft

## Story
**As a** user,
**I want** an interactive screen to refine and analyze keyword data,
**so that** I can select the best keywords for my article.

## Acceptance Criteria
1. User can view all keyword data from different sources (AI-generated, CSV imports) in an interactive table interface
2. User can filter keywords by search volume, difficulty, competition level, CPC range, and data source
3. User can sort keywords by any column (text, volume, difficulty, competition, CPC, source)
4. User can search/filter keywords by text using a search box
5. User can select individual keywords or multiple keywords using checkboxes
6. User can see detailed information for each keyword including all tool-specific metrics
7. User can compare keywords side-by-side with visual indicators for metrics
8. User can export selected keywords in multiple formats (CSV, JSON, plain text)
9. User can right-click on keywords to add them to existing project-level keyword lists or create new ones, and can view/manage these lists in a dedicated interface
10. Interface provides clear visual feedback for user actions and maintains state across page navigation

## Tasks / Subtasks
- [ ] Task 0: Git workflow setup (Required before implementation)
  - [ ] Create and checkout feature branch: `feature/3.1-interactive-keyword-refinement`
  - [ ] Verify branch is properly created and pushed to origin
  - [ ] Document branch creation commit ID in Dev Agent Record
- [ ] Task 1: Enhance existing KeywordDataTable with interactive filtering capabilities (AC: 1, 2, 3, 4)
  - [ ] Add advanced filter panel component with filter controls for volume range, difficulty range, CPC range, competition level, and data source
  - [ ] Implement client-side filtering logic for all keyword metadata including external tool data
  - [ ] Add column-based sorting functionality for all displayed columns
  - [ ] Enhance search functionality to support fuzzy text matching
  - [ ] Commit with message: "feat: add advanced filtering and sorting to keyword data table"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 2: Implement keyword selection and comparison features (AC: 5, 6, 7)
  - [ ] Add multi-select checkbox functionality with "select all" capability
  - [ ] Create detailed keyword view modal showing all tool-specific metrics from external_tool_data JSONB field
  - [ ] Implement side-by-side keyword comparison interface with visual metric indicators
  - [ ] Add bulk action controls for selected keywords
  - [ ] Commit with message: "feat: implement keyword selection and comparison features"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 3: Create keyword export functionality (AC: 8)
  - [ ] Implement export service supporting CSV, JSON, and plain text formats
  - [ ] Add export options for selected keywords vs all visible keywords
  - [ ] Include all metadata fields in exports (volume, difficulty, CPC, competition, tool source, external_tool_data)
  - [ ] Add download functionality with proper file naming based on project and timestamp
  - [ ] Commit with message: "feat: implement keyword export functionality"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 4: Implement project-level keyword list management with context menu (AC: 9)
  - [ ] Create API endpoints for project-level keyword list CRUD operations (create, read, update, delete lists)
  - [ ] Implement right-click context menu on keyword rows with "Add to list" options
  - [ ] Add modal for creating new keyword lists with name and description
  - [ ] Create dedicated keyword lists management page at `/projects/[id]/keyword-lists`
  - [ ] Implement keyword list viewer with similar table interface as keyword data table
  - [ ] Add ability to remove keywords from lists and delete entire lists
  - [ ] Commit with message: "feat: implement project-level keyword list management with context menus"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 5: Create interactive refinement page integration (AC: 10)
  - [ ] Create dedicated refinement page/route at `/projects/[id]/keywords/refine`
  - [ ] Integrate all refinement features into cohesive interface
  - [ ] Add navigation breadcrumbs and state management
  - [ ] Implement URL parameters for preserving filter and selection state
  - [ ] Add loading states and error handling for all interactive features
  - [ ] Commit with message: "feat: create interactive keyword refinement page"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 6: Testing (All ACs)
  - [ ] Write unit tests for filtering logic and keyword selection functionality
  - [ ] Write unit tests for export service and file generation
  - [ ] Write unit tests for keyword list management API endpoints and right-click context menu
  - [ ] Write unit tests for refinement page and keyword list page components
  - [ ] Write E2E tests for complete keyword refinement workflow including list management
  - [ ] Test performance with large keyword datasets (1000+ keywords)
  - [ ] Test right-click context menu functionality and keyword list operations
  - [ ] Test integration with existing keyword generation and CSV import workflows
  - [ ] Commit with message: "test: add comprehensive keyword refinement test coverage"
  - [ ] Document commit ID in Dev Agent Record

## Dev Notes

**Epic 3 Context:**
This story establishes the interactive keyword refinement capabilities that form the foundation for Epic 3's goal of developing keyword analysis and curation tools. It builds directly on the completed Epic 2 workflows (content ingestion, AI generation, and CSV import) to provide the analysis interface.

**Previous Story Integration:**
Building on Story 2.3's CSV import and data table foundations:
- **Data Table Enhancement:** Extend existing KeywordDataTable.tsx with advanced filtering and interaction capabilities
- **External Tool Data:** Leverage external_tool_data JSONB field for detailed metric display and filtering
- **Regional Context:** Maintain geographic region support established in Story 2.2.5
- **Source Attribution:** Use established tool source tracking (Semrush, Ahrefs, Google Keyword Planner, AI Generated)

**Data Models Used:**
Based on existing keyword schema from Story 2.3 [Source: architecture/data-models.md]:
- **Keyword**: Contains text, search_volume, difficulty, region, external_tool_data JSONB, tool_source
- **Keyword List**: Project-level named collections of keywords for organizing research across all pages
- **Project**: Parent container with default_region for regional context
- **External Tool Data**: JSONB field containing tool-specific metrics (semrush_cpc, ahrefs_searchVolume, etc.)

**API Specifications:**
Extending existing API endpoints from Story 2.3 [Source: architecture/rest-api-spec.md]:
- **GET /api/v1/projects/:id/keywords** - Already exists, extend with refinement filtering parameters
- **GET /api/v1/projects/:id/keyword-lists** - New endpoint for retrieving project keyword lists
- **POST /api/v1/projects/:id/keyword-lists** - New endpoint for creating project-level keyword lists
- **PUT /api/v1/projects/:id/keyword-lists/:listId** - New endpoint for updating keyword lists (add/remove keywords)
- **DELETE /api/v1/projects/:id/keyword-lists/:listId** - New endpoint for deleting keyword lists
- **POST /api/v1/projects/:id/keyword-lists/:listId/keywords** - New endpoint for adding keywords to existing lists

**Component Architecture:**
Building on existing UI components [Source: architecture/components.md]:
- **KeywordDataTable.tsx** - Enhance with filtering, sorting, selection, and right-click context menu
- **FilterPanel.tsx** - New component for advanced keyword filtering controls
- **KeywordComparison.tsx** - New component for side-by-side keyword analysis
- **KeywordContextMenu.tsx** - New component for right-click menu with "Add to list" options
- **KeywordListPage.tsx** - New page component for viewing and managing project keyword lists
- **RefinementPage.tsx** - New main page component integrating all refinement features

**Database Schema Integration:**
Uses existing flexible schema from Story 2.2.5:
```sql
-- Keywords table (existing)
region VARCHAR(5)              -- Geographic region context
external_tool_data JSONB       -- Tool-specific metrics for filtering
tool_source VARCHAR(50)        -- Source attribution for filtering

-- New keyword_lists table
CREATE TABLE keyword_lists (
    id UUID PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    project_id UUID REFERENCES projects(id),
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- New keyword_list_items table (many-to-many)
CREATE TABLE keyword_list_items (
    keyword_list_id UUID REFERENCES keyword_lists(id),
    keyword_id UUID REFERENCES keywords(id),
    added_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (keyword_list_id, keyword_id)
);
```

**Filtering Implementation Strategy:**
Advanced filtering based on existing keyword metadata:
- **Volume Range:** Filter by search_volume field and tool-specific volumes in external_tool_data
- **Difficulty Range:** Filter by difficulty field and tool-specific difficulties (semrush_difficulty, ahrefs_difficulty)
- **CPC Range:** Filter by CPC values from external_tool_data (semrush_cpc, ahrefs_cpc, google_keyword_planner_topBidLow)
- **Competition Level:** Filter by competition metrics from Google Keyword Planner data
- **Source Filter:** Filter by tool_source and last_import_source in external_tool_data
- **Text Search:** Fuzzy matching on keyword text field

**Export Functionality:**
Multiple export formats preserving all data context:
- **CSV Export:** Include all columns (text, volume, difficulty, CPC, competition, source, region)
- **JSON Export:** Full keyword objects with external_tool_data for advanced analysis
- **Plain Text:** Simple keyword list for copy-paste workflows
- **File Naming:** Use project name, timestamp, and filter context for clear identification

**UI/UX Standards:**
Following established patterns from Stories 2.2.5 and 2.3:
- **Custom Modals:** No browser default prompts, use custom modal components
- **Loading States:** Clear progress indicators during filtering and data operations
- **Error Handling:** Comprehensive error messages with actionable guidance
- **State Management:** URL parameters for preserving filter state across navigation
- **Responsive Design:** Mobile-friendly interface using Tailwind CSS classes

**Performance Considerations:**
- **Client-Side Filtering:** Implement efficient filtering for datasets up to 1000+ keywords
- **Lazy Loading:** Load detailed keyword data on-demand for performance
- **Debounced Search:** Implement search input debouncing to prevent excessive filtering
- **Virtual Scrolling:** Consider virtual scrolling for very large keyword lists
- **Memoization:** Use React.useMemo for expensive filtering computations

**Integration with Sequential Workflow:**
Building on Story 2.2.5's sequential workflow:
- **Navigation Integration:** Add refinement step to page-by-page processing flow
- **Region Context:** Maintain geographic region filtering throughout refinement
- **Data Persistence:** Save refinement state across workflow navigation
- **Progress Tracking:** Track refinement completion status for each page

**File Locations:**
Following established Next.js structure:
- **Pages:** `/src/app/projects/[id]/keywords/refine/page.tsx` - Main refinement page
- **Pages:** `/src/app/projects/[id]/keyword-lists/page.tsx` - Project keyword lists management page
- **Components:** `/src/components/keyword-refinement/` - Refinement-specific components
- **Components:** `/src/components/KeywordContextMenu.tsx` - Right-click context menu component
- **API Routes:** `/src/app/api/v1/projects/[id]/keyword-lists/` - Keyword list CRUD endpoints
- **Services:** `/src/lib/services/keywordFilter.ts`, `/src/lib/services/keywordExport.ts`, `/src/lib/services/keywordListManager.ts`
- **Utils:** `/src/lib/utils/filterUtils.ts`, `/src/lib/utils/exportUtils.ts`, `/src/lib/utils/contextMenuUtils.ts`
- **Tests:** `/tests/keyword-refinement.spec.ts`, `/tests/keyword-lists.spec.ts` - E2E workflow tests

**Security Considerations:**
- **Project Ownership:** Users can only refine keywords from their tenant's projects
- **Authentication Required:** All refinement operations require valid session
- **Data Export Limits:** Implement reasonable limits on export file sizes
- **Input Validation:** Validate all filter parameters and export requests

**Tech Stack Requirements:**
- Use TypeScript for all development [Source: architecture/tech-stack.md]
- Use Zod for filter parameter validation and export data validation
- Use Prisma for database operations with new keyword list tables
- Use Tailwind CSS for refinement UI components
- Use React hooks for state management and performance optimization

### Testing
**Testing Standards from Architecture:**
- Use Playwright for end-to-end testing [Source: architecture/tech-stack.md]
- All tests must pass for story completion [Source: architecture/coding-standards.md]
- Follow established testing patterns from previous stories
- Test filtering performance with large keyword datasets
- Test export functionality with various data formats
- Test keyword list management with create, update, delete operations and right-click workflows
- Test integration with existing keyword generation and import workflows
- Test state persistence across page navigation and URL parameters

**Git & Documentation Standards:**
- Feature branch: `feature/3.1-interactive-keyword-refinement`
- Conventional commit format with Claude Code attribution
- Complete Dev Agent Record with commit hashes and quality gates
- Zero TypeScript/lint errors required before completion

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-20 | 1.0 | Initial interactive keyword refinement story for Epic 3 foundation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
*Results from QA Agent review will be populated here*