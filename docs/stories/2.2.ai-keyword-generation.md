# Story 2.2: AI-Powered Keyword Generation

## Status
Approved

## Story
**As a** user,
**I want** to be able to use a custom AI model and prompt to generate an initial list of 100 potential keywords from the ingested content,
**so that** I can have a great starting point for my research.

## Acceptance Criteria
1. User can configure AI model settings and prompts for their tenant
2. User can trigger keyword generation from ingested page content
3. System generates approximately 100 keywords using AI analysis of page content
4. Generated keywords are saved to the database linked to the project
5. User can view the generated keyword list with clear presentation
6. User can copy keyword list to clipboard for external use
7. System provides feedback during AI processing with loading states
8. System handles AI service errors gracefully with custom error modals (no browser prompts)
9. AI prompt and model settings are tenant-scoped and reusable
10. Keyword generation respects authentication and project ownership

## Tasks / Subtasks
- [ ] Task 0: Git workflow setup (Required before implementation)
  - [ ] Create and checkout feature branch: `feature/2.2-ai-keyword-generation`
  - [ ] Verify branch is properly created and pushed to origin
  - [ ] Document branch creation commit ID in Dev Agent Record
- [ ] Task 1: Extend database schema for AI and keyword entities (AC: 1, 4, 9)
  - [ ] Add AI Prompt model to Prisma schema per data model specification
  - [ ] Add Keyword List model with relationship to Project
  - [ ] Add Keyword model with relationship to Keyword List
  - [ ] Include fields for AI model type, prompt text, and tenant scoping
  - [ ] Run database migration for schema updates
  - [ ] Commit with message: "feat: add AI prompt and keyword models for AI generation"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 2: Implement AI service integration (AC: 2, 3, 7, 8)
  - [ ] Create AI service module for keyword generation
  - [ ] Implement integration with AI providers (OpenAI, Anthropic, or configurable)
  - [ ] Add prompt template system for keyword generation
  - [ ] Add error handling for AI service failures and rate limits
  - [ ] Add timeout and retry logic for AI requests
  - [ ] Consider environment configuration for AI API keys
  - [ ] Commit with message: "feat: implement AI service for keyword generation"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 3: Create keyword generation API endpoints (AC: 2, 3, 4, 8, 10)
  - [ ] Implement POST /api/v1/projects/:id/pages/:pageId/keywords endpoint
  - [ ] Implement GET /api/v1/projects/:id/keywords endpoint for listing keywords
  - [ ] Add authentication middleware and project ownership validation
  - [ ] Integrate AI service for content-based keyword generation
  - [ ] Add proper error handling and response formatting
  - [ ] Add input validation with Zod schemas
  - [ ] Commit with message: "feat: implement keyword generation API endpoints"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 4: Create AI configuration UI components (AC: 1, 9)
  - [ ] Create AISettingsForm component for model and prompt configuration
  - [ ] Add support for different AI providers and models
  - [ ] Create prompt template editor with preview functionality
  - [ ] Add tenant-scoped AI settings management
  - [ ] Implement form validation and user feedback
  - [ ] Add responsive design with Tailwind CSS
  - [ ] Commit with message: "feat: implement AI configuration UI components"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 5: Create keyword generation UI components (AC: 3, 5, 6, 7, 8)
  - [ ] Create KeywordGenerationTrigger component for initiating AI processing
  - [ ] Create KeywordList component for displaying generated keywords
  - [ ] Create CopyToClipboard component for keyword export
  - [ ] Implement loading states for AI processing
  - [ ] Add custom error modals for AI failures (no browser prompts)
  - [ ] Add keyword count display and generation metadata
  - [ ] Add responsive design with Tailwind CSS
  - [ ] Commit with message: "feat: implement keyword generation UI components"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 6: Create keyword generation page integration (AC: 2, 5, 6, 10)
  - [ ] Create /projects/:id/keywords page for keyword management
  - [ ] Integrate keyword generation with content ingestion workflow
  - [ ] Add navigation from content pages to keyword generation
  - [ ] Ensure proper authentication protection for keyword pages
  - [ ] Add project context validation for keyword operations
  - [ ] Update project workflow to include keyword generation step
  - [ ] Commit with message: "feat: create keyword generation page with project integration"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 7: Testing (All ACs)
  - [ ] Write unit tests for AI service integration
  - [ ] Write unit tests for keyword generation API endpoints
  - [ ] Write unit tests for AI configuration UI components
  - [ ] Write unit tests for keyword generation UI components
  - [ ] Write E2E tests for complete keyword generation workflow
  - [ ] Test custom error modal handling for AI failures
  - [ ] Test integration with authentication and project system
  - [ ] Test AI configuration persistence and tenant isolation
  - [ ] Commit with message: "test: add comprehensive keyword generation test coverage"
  - [ ] Document commit ID in Dev Agent Record

## Dev Notes

**Story 2.2 Context:**
- **Continuation of Epic 2**: Builds directly on Story 2.1 content ingestion foundation
- **Core Workflow Implementation**: Implements AI keyword generation stage from architecture
- **Next Story**: Story 2.3 will add CSV import to merge external keyword data

**Previous Story Foundation (Story 2.1):**
- **Page Entity**: Content ingestion complete with Page model and web scraping
- **Content Processing**: HTML/markdown content available for AI analysis
- **Project Integration**: Content linked to projects with authentication
- **UI Foundation**: Content ingestion workflow and navigation established

**Data Models:**
- **AI Prompt**: Entity for customizable prompt text and AI model selection [Source: architecture/data-models.md#ai-prompt]
- **Keyword List**: Entity for named lists of keywords within project [Source: architecture/data-models.md#keyword-list]
- **Keyword**: Entity for individual keywords with stats [Source: architecture/data-models.md#keyword]
- **Page**: Existing entity from Story 2.1 containing content for AI analysis

**Database Schema Requirements:**
New models needed for AI-powered keyword generation:
- AI Prompt: id, tenant_id, name, prompt_text, ai_model, created_at
- Keyword List: id, project_id, name, page_id, generated_at, created_at
- Keyword: id, keyword_list_id, text, search_volume, difficulty, created_at

**Component Architecture:**
- **AI Service**: Handles interactions with AI models for keyword generation [Source: architecture/components.md#ai-service]
- **UI Component**: React frontend for AI configuration and keyword display [Source: architecture/components.md#ui-component]
- **API Service**: Node.js backend for AI orchestration and keyword management [Source: architecture/components.md#api-service]
- **Database Service**: Neon database for keyword and AI prompt persistence [Source: architecture/components.md#database-service]

**Core Workflow Integration:**
This story implements the AI generation stage of keyword research workflow [Source: architecture/core-workflows.md#keyword-research-workflow]:
1. Content ingestion (Story 2.1) ✅ Complete
2. API requests AI to generate keywords ✅ (This story)
3. AI returns 100 keywords ✅ (This story)
4. API saves keywords to database ✅ (This story)
5. App displays keywords ✅ (This story)
6. Copy to clipboard functionality ✅ (This story)

**Tech Stack Requirements:**
- Use TypeScript for all development [Source: architecture/tech-stack.md]
- Use Zod for data validation on frontend and backend [Source: architecture/tech-stack.md]
- Use Prisma for database ORM [Source: architecture/tech-stack.md]
- Use Tailwind CSS for styling [Source: architecture/tech-stack.md]
- AI service integration (OpenAI, Anthropic Claude, or configurable provider)

**Environment Configuration:**
- **AI Service API Keys**: Add environment variables for AI provider authentication
- **AI Service URLs**: Configure endpoints for different AI providers
- **Rate Limiting**: Configure AI request limits and timeout settings
- **Dev Server Port**: Continue using port 3060 for consistency
- **Database**: Continue using flowseo_dev database
- **Authentication**: Reuse JWT_SECRET and session configuration

**Security Considerations:**
- **Tenant Isolation**: AI prompts and keywords scoped to user's tenant
- **Project Ownership**: Users can only generate keywords for their tenant's projects
- **AI API Key Security**: Secure storage and transmission of AI service credentials
- **Rate Limiting**: Prevent abuse of AI services with proper throttling
- **Content Sanitization**: Ensure page content is safe for AI processing
- **Authentication Required**: All keyword operations require valid session

**UX Standards (Custom Modals):**
- **Custom Error Modals**: No browser default prompts for AI service failures
- **Loading States**: Clear feedback during AI processing (potentially 10-30 seconds)
- **Professional UI**: Consistent styling with existing app design
- **Copy-to-Clipboard**: Smooth UX for keyword export functionality
- **Progress Indicators**: Show AI processing progress where possible

**Performance Considerations:**
- **Async AI Processing**: Handle long-running AI requests gracefully
- **Background Processing**: Consider queue system for heavy AI workloads
- **Response Caching**: Cache generated keywords to avoid redundant AI calls
- **Progressive Loading**: Display keywords as they're generated if possible
- **Timeout Handling**: Graceful degradation for slow AI responses

**Integration with Story 2.1 Foundation:**
Building on completed content ingestion:
- Use existing Page entities as input for AI keyword generation
- Leverage established project ownership validation
- Extend content workflow to include keyword generation step
- Use existing authentication and navigation patterns

**File Locations:**
Following Next.js structure from previous stories:
- API routes: `/src/app/api/v1/projects/[id]/pages/[pageId]/keywords/` directory
- AI service: `/src/lib/services/aiService.ts`
- Components: `/src/components/` directory (KeywordList, AISettingsForm, etc.)
- Shared UI components: `/src/components/ui/` directory (existing modals, new keyword components)
- Keyword pages: `/src/app/projects/[id]/keywords/page.tsx`
- E2E tests: `/tests/keyword-generation.spec.ts`
- Unit tests: Colocated with components and API routes

**AI Service Architecture:**
- **Provider Abstraction**: Support multiple AI providers (OpenAI, Anthropic, etc.)
- **Prompt Templates**: Customizable prompts for different keyword generation strategies
- **Response Processing**: Parse and validate AI responses for keyword extraction
- **Error Handling**: Graceful handling of AI service outages and rate limits
- **Configuration Management**: Tenant-scoped AI settings and preferences

**Project Structure Notes:**
Maintains existing Next.js structure from Epic 1 and Story 2.1. AI keyword generation integrates cleanly with established authentication, project management, content ingestion, and UI patterns.

### Testing
**Testing Standards from Architecture:**
- Use Playwright for end-to-end testing [Source: architecture/tech-stack.md]
- All tests must pass for story completion [Source: architecture/coding-standards.md]
- Follow established testing patterns from previous stories
- Test AI service integration with mock responses for reliable testing
- Test keyword generation with authentication and project context
- Test AI configuration persistence and tenant isolation

**Git & Documentation Standards:**
- Feature branch: `feature/2.2-ai-keyword-generation`
- Conventional commit format with Claude Code attribution
- Complete Dev Agent Record with commit hashes and quality gates
- Zero TypeScript/lint errors required before completion

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial AI keyword generation story creation for Epic 2 continuation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
- TypeScript compilation: `pnpm run type-check` - ✅/❌ [actual status]
- Linting: `pnpm run lint` - ✅/❌ [actual status]
- Build: `pnpm run build` - ✅/❌ [actual status]
- Tests: `pnpm run test` - ✅/❌ [actual status]

### Git Commits Created During This Session
**MANDATORY:** All commit IDs must be documented with conventional commit messages
- Branch creation: `[hash]` - Initial branch setup
- Task 1: `[hash]` - feat: add AI prompt and keyword models for AI generation
- Task 2: `[hash]` - feat: implement AI service for keyword generation
- Task 3: `[hash]` - feat: implement keyword generation API endpoints
- Task 4: `[hash]` - feat: implement AI configuration UI components
- Task 5: `[hash]` - feat: implement keyword generation UI components
- Task 6: `[hash]` - feat: create keyword generation page with project integration
- Task 7: `[hash]` - test: add comprehensive keyword generation test coverage

### Completion Notes List
*To be filled by dev agent*

### File List
**New Files Created:**
*To be filled by dev agent*

**Modified Files:**
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*