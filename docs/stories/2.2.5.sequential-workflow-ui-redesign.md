# Story 2.2.5: Sequential Workflow UI Redesign with Geographic Regions

## Status
Approved

## Story
**As a** user,
**I want** a sequential page-by-page workflow with geographic region support and proper data table interface for keywords,
**so that** I can process my content systematically with accurate regional SEO data and manage keywords effectively.

## Acceptance Criteria
1. User can select default geographic region at project level (US, UK, AU, CA with UK default)
2. Keyword generation UI displays keywords in sortable data table instead of cards
3. Data table includes columns for Keyword, Volume, Difficulty, Competition, CPC, and tool-specific metrics
4. User can select individual keywords from the data table for workflow progression
5. User can track which scraped pages have been analyzed per geographic region
6. System maintains existing batch keyword generation functionality (no regression)
7. Page-level keywords are separated from project-level named keyword lists
8. External tool data is stored flexibly to accommodate different schemas (Semrush, Ahrefs, Keyword Planner)
9. Geographic region context is applied consistently across all keyword operations
10. Sequential workflow shows clear progression status for each page per region

## Tasks / Subtasks
- [x] Task 0: Git workflow setup (Required before implementation)
  - [x] Create and checkout feature branch: `feature/2.2.5-sequential-workflow-ui-redesign`
  - [x] Verify branch is properly created and pushed to origin
  - [x] Document branch creation commit ID in Dev Agent Record
- [ ] Task 1: Extend database schema for geographic regions and flexible data (AC: 1, 7, 8, 9)
  - [ ] Add default_region field to Project model (US, UK, AU, CA - UK default)
  - [ ] Add region field to KeywordList and Keyword models
  - [ ] Add external_tool_data JSONB field to Keyword model for flexible tool schemas
  - [ ] Add analysis_status JSONB field to Page model for tracking analysis per region
  - [ ] Modify KeywordList relationship from page-level to project-level
  - [ ] Run database migration for schema updates
  - [ ] Commit with message: "feat: add geographic regions and flexible data schema"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 2: Create geographic region selection components (AC: 1, 9)
  - [ ] Create RegionSelector component for project-level region choice
  - [ ] Add region selection to project creation and editing forms
  - [ ] Update project management UI to display and modify default region
  - [ ] Add region context provider for consistent application throughout workflow
  - [ ] Implement region validation and default handling
  - [ ] Commit with message: "feat: implement geographic region selection"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 3: Redesign keyword generation UI with data table (AC: 2, 3, 4, 6)
  - [ ] Replace KeywordList card display with sortable data table component
  - [ ] Add columns: Keyword, Volume, Difficulty, Competition, CPC, Tool Source
  - [ ] Implement sorting functionality for all data columns
  - [ ] Add keyword selection mechanism (checkboxes/multi-select)
  - [ ] Add pagination for large keyword lists
  - [ ] Maintain existing copy-to-clipboard functionality
  - [ ] Keep existing batch generation functionality alongside new table
  - [ ] Add responsive design for mobile/tablet viewing
  - [ ] Commit with message: "feat: redesign keyword UI with sortable data table"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 4: Implement page analysis status tracking (AC: 5, 10)
  - [ ] Create PageAnalysisTracker component showing analysis status per region
  - [ ] Add visual indicators for analyzed/unanalyzed pages by region
  - [ ] Update project dashboard to show overall analysis progress
  - [ ] Add navigation between content ingestion and keyword analysis per page
  - [ ] Implement status updates when pages are analyzed
  - [ ] Show analysis timestamps and region context
  - [ ] Commit with message: "feat: implement page analysis status tracking"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 5: Implement flexible external tool data schema (AC: 8)
  - [ ] Create ExternalToolDataMapper utility for handling different tool schemas
  - [ ] Define common metric categories (Volume, Difficulty, Competition, CPC)
  - [ ] Implement flexible JSONB storage for tool-specific unique metrics
  - [ ] Add tool source tracking (Semrush, Ahrefs, Keyword Planner, AI Generated)
  - [ ] Create UI components for displaying mixed tool data consistently
  - [ ] Add data validation and error handling for external tool imports
  - [ ] Commit with message: "feat: implement flexible external tool data schema"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 6: Update keyword generation API endpoints for regions (AC: 1, 9)
  - [ ] Modify keyword generation endpoints to accept region parameter
  - [ ] Update AI service integration to include region context in prompts
  - [ ] Add region validation to all keyword-related API operations
  - [ ] Update keyword listing endpoints to filter by region
  - [ ] Ensure backward compatibility with existing keyword data
  - [ ] Add proper error handling for region-specific operations
  - [ ] Commit with message: "feat: update keyword APIs for geographic region support"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 7: Integrate sequential workflow navigation (AC: 10)
  - [ ] Create workflow navigation component showing page progression
  - [ ] Add "Next Page" and "Previous Page" navigation in keyword analysis
  - [ ] Implement workflow state management for sequential processing
  - [ ] Add workflow completion tracking and summary views
  - [ ] Connect page analysis status with navigation flow
  - [ ] Ensure custom modal dialogs for workflow transitions (no browser prompts)
  - [ ] Commit with message: "feat: implement sequential workflow navigation"
  - [ ] Document commit ID in Dev Agent Record
- [ ] Task 8: Testing (All ACs)
  - [ ] Write unit tests for geographic region selection and validation
  - [ ] Write unit tests for keyword data table components
  - [ ] Write unit tests for page analysis status tracking
  - [ ] Write unit tests for flexible external tool data schema
  - [ ] Write E2E tests for complete sequential workflow
  - [ ] Test region context consistency across all operations
  - [ ] Test backward compatibility with existing batch functionality
  - [ ] Test integration with updated keyword generation APIs
  - [ ] Commit with message: "test: add comprehensive sequential workflow test coverage"
  - [ ] Document commit ID in Dev Agent Record

## Dev Notes

**Sprint Change Context:**
- **Issue Identified:** Fundamental workflow mismatch between batch processing vs sequential page-by-page flow
- **Course Correction:** Add sequential workflow while maintaining existing batch functionality
- **Geographic Insight:** Critical discovery that SEO data varies significantly by region (UK vs US vs AU vs CA)

**Previous Story Foundation:**
- **Story 2.1** ✅ Content ingestion foundation (no changes needed)
- **Story 2.2** ✅ AI keyword generation (keep existing, add new workflow)
- **User Feedback:** Current keyword cards unusable - need sortable data table with selection

**Database Schema Extensions:**
```sql
-- Project level region support
ALTER TABLE projects ADD COLUMN default_region VARCHAR(5) DEFAULT 'UK';

-- Keyword level region and flexible data
ALTER TABLE keyword_lists ADD COLUMN region VARCHAR(5);
ALTER TABLE keywords ADD COLUMN region VARCHAR(5);
ALTER TABLE keywords ADD COLUMN external_tool_data JSONB;

-- Page analysis tracking
ALTER TABLE pages ADD COLUMN analysis_status JSONB;

-- Move keyword lists to project level (modify existing relationship)
```

**Geographic Region Support:**
- **Supported Regions:** US, UK, AU, CA (UK Default)
- **Region Selection:** Project level for cleaner data management
- **Data Isolation:** Separate keyword data per region to prevent mixing incompatible metrics
- **AI Integration:** Include region context in AI prompts for relevant keyword generation

**UI Component Redesign:**
Current keyword cards → Sortable data table with columns:
- **Keyword** (text, sortable)
- **Volume** (numeric, sortable)
- **Difficulty** (numeric, sortable)
- **Competition** (numeric/text, sortable)
- **CPC** (currency, sortable)
- **Tool Source** (Semrush/Ahrefs/Keyword Planner/AI)
- **Tool-Specific Metrics** (flexible JSONB display)

**External Tool Integration Strategy:**
- **Common Metrics:** Map tool variations to standard categories
- **Unique Metrics:** Preserve tool-specific data in JSONB schema
- **Supported Tools:** Semrush, Ahrefs, Google Keyword Planner (extensible)
- **Flexibility:** Accommodate different column names/formats from each tool

**Sequential Workflow Architecture:**
1. **Page Selection** → Choose page to analyze
2. **Region Confirmation** → Verify/change region for this analysis
3. **Keyword Generation** → AI-powered keyword list with data table
4. **External Tool Import** → CSV import with schema mapping
5. **Keyword Selection** → Choose keywords for further analysis
6. **Progress Tracking** → Visual status of all pages per region

**Integration with Existing System:**
- **No Regression:** Existing batch functionality remains fully operational
- **Additive Changes:** New components work alongside existing ones
- **Backward Compatibility:** Existing keyword data works with new schema
- **Authentication Integration:** Uses existing auth context and protected routes
- **Project Integration:** Builds on existing project management foundation

**Tech Stack Requirements:**
- Use TypeScript for all development [Source: architecture/tech-stack.md]
- Use Zod for data validation including region validation schemas
- Use Prisma for database ORM with schema extensions
- Use Tailwind CSS for data table responsive design
- Maintain existing authentication and project context patterns

**Environment Configuration:**
- **Dev Server Port:** Continue using port 3060 for consistency
- **Database:** Continue using flowseo_dev database with migrations
- **Authentication:** Reuse existing JWT_SECRET and session configuration
- **Region Configuration:** No additional environment variables needed

**Security Considerations:**
- **Tenant Isolation:** Region data scoped to user's tenant
- **Project Ownership:** Users can only access their tenant's projects and regions
- **Data Validation:** Region parameters validated on both frontend and backend
- **External Tool Data:** Sanitize imported CSV data to prevent injection attacks
- **Authentication Required:** All workflow operations require valid session

**UX Standards (Custom Modals):**
- **Custom Modal Dialogs:** No browser default prompts for workflow transitions
- **Loading States:** Clear feedback during region-specific operations
- **Professional UI:** Consistent styling with existing app design
- **Data Table UX:** Sortable columns, pagination, search/filter capabilities
- **Progress Indicators:** Visual workflow completion status per page/region

**Performance Considerations:**
- **Data Table Optimization:** Virtual scrolling for large keyword lists
- **Region Context Caching:** Cache region selection to avoid repeated API calls
- **Progressive Loading:** Load keyword data incrementally for better UX
- **Index Optimization:** Database indexes on region fields for query performance

**File Locations:**
Following Next.js structure from previous stories:
- API routes: Extend existing `/src/app/api/v1/projects/[id]/keywords/` routes
- Components: `/src/components/` directory (RegionSelector, KeywordDataTable, PageAnalysisTracker)
- Data table components: `/src/components/ui/` directory (DataTable, SortableColumns)
- Workflow components: `/src/components/workflow/` directory (SequentialFlow, WorkflowNavigation)
- Utilities: `/src/lib/utils/` directory (externalToolMapper, regionValidator)
- E2E tests: `/tests/sequential-workflow.spec.ts`
- Unit tests: Colocated with components and API routes

**Integration with Story 2.3 (CSV Import):**
- CSV import will use new flexible external tool data schema
- Region context will be applied to imported keyword data
- Tool source will be tracked for all imported keywords
- Schema mapping will accommodate different tool formats

**Project Structure Notes:**
Maintains existing Next.js structure while adding workflow-specific organization. Sequential workflow integrates cleanly with established authentication, project management, content ingestion, and keyword generation patterns.

### Testing
**Testing Standards from Architecture:**
- Use Playwright for end-to-end testing [Source: architecture/tech-stack.md]
- All tests must pass for story completion [Source: architecture/coding-standards.md]
- Follow established testing patterns from previous stories
- Test geographic region consistency across all operations
- Test data table functionality with large datasets
- Test sequential workflow navigation and state management
- Test external tool data schema flexibility
- Test backward compatibility with existing batch functionality

**Git & Documentation Standards:**
- Feature branch: `feature/2.2.5-sequential-workflow-ui-redesign`
- Conventional commit format with Claude Code attribution
- Complete Dev Agent Record with commit hashes and quality gates
- Zero TypeScript/lint errors required before completion

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-19 | 1.0 | Initial sequential workflow UI redesign story from course correction analysis | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- TypeScript compilation: `pnpm run type-check` - ✅/❌ [actual status]
- Linting: `pnpm run lint` - ✅/❌ [actual status]
- Build: `pnpm run build` - ✅/❌ [actual status]
- Tests: `pnpm run test` - ✅/❌ [actual status]

### Git Commits Created During This Session
**MANDATORY:** All commit IDs must be documented with conventional commit messages
- Branch creation: `524cc74a9032cd13d65fdf12d27a333f05b70a30` - Initial branch setup
- Task 1: `[hash]` - feat: add geographic regions and flexible data schema
- Task 2: `[hash]` - feat: implement geographic region selection
- Task 3: `[hash]` - feat: redesign keyword UI with sortable data table
- Task 4: `[hash]` - feat: implement page analysis status tracking
- Task 5: `[hash]` - feat: implement flexible external tool data schema
- Task 6: `[hash]` - feat: update keyword APIs for geographic region support
- Task 7: `[hash]` - feat: implement sequential workflow navigation
- Task 8: `[hash]` - test: add comprehensive sequential workflow test coverage

### Completion Notes List
*To be filled by dev agent*

### File List
**New Files Created:**
*To be filled by dev agent*

**Modified Files:**
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here*